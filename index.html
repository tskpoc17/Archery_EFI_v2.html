<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EFI å°„ç®­é›™è»¸è¨ºæ–·ç³»çµ±</title>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg); padding: 15px; display: flex; justify-content: center; margin: 0; }
        .container { background: white; width: 100%; max-width: 450px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); padding: 20px; box-sizing: border-box; }
        .header { text-align: center; margin-bottom: 20px; }
        .section-box { background: #e7f3ff; border-radius: 16px; padding: 15px; margin-bottom: 15px; border-left: 6px solid var(--primary); }
        .section-title { font-weight: bold; color: var(--primary); margin-bottom: 12px; font-size: 15px; }
        input { width: 100%; padding: 12px; border: 1px solid #dee2e6; border-radius: 10px; font-size: 15px; box-sizing: border-box; }
        button { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-diag { background: var(--primary); color: white; margin: 15px 0; font-size: 16px; }
        .btn-save { background: var(--success); color: white; margin-bottom: 10px; }
        .history-row { display: flex; gap: 8px; margin-bottom: 15px; }
        select { flex: 1.5; padding: 10px; border-radius: 10px; border: 1px solid #ddd; }
        .analysis-box { background: #fff4e6; border-radius: 16px; padding: 18px; border: 1px solid #ffe8cc; font-size: 14px; line-height: 1.6; }
        .result-card { background: #fff; border-radius: 15px; padding: 15px; border: 1px solid #eef2f7; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header"><h1>ğŸ¯ EFI é›™è»¸è¨ºæ–·ç³»çµ±</h1></div>

    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <input type="number" id="kValue" value="1" placeholder="Kå€¼" style="flex: 1;">
    </div>

    <div class="section-box">
        <div class="section-title">âš–ï¸ X è»¸æ°´å¹³åº§æ¨™åˆ†å€¼</div>
        <input type="text" id="rawX" placeholder="è¼¸å…¥åº§æ¨™ï¼Œå¦‚ï¼š2,1,-1,-3">
    </div>

    <div class="section-box" style="background: #f0f7ff; border-left-color: #28a745;">
        <div class="section-title" style="color: #28a745;">â†•ï¸ Y è»¸å‚ç›´åº§æ¨™åˆ†å€¼</div>
        <input type="text" id="rawY" placeholder="è¼¸å…¥åº§æ¨™ï¼Œå¦‚ï¼š3,0.5,-2,-4">
    </div>

    <button class="btn-diag" onclick="runDiag()">åŸ·è¡Œé›™è»¸æ•¸æ“šè¨ºæ–·</button>

    <button id="p_save" class="btn-save">ğŸ•’ å„²å­˜æ•¸æ“šèˆ‡æ™‚é–“</button>
    <div class="history-row">
        <select id="p_list"></select>
        <button onclick="loadRecord()" style="flex:0.8; background:#6f42c1; color:white;">è¼‰å…¥</button>
        <button onclick="delRecord()" style="flex:0.6; background:var(--danger); color:white;">åˆªé™¤</button>
    </div>

    <div class="analysis-box">
        <strong>ğŸ’¡ ç¶œåˆåˆ†æå»ºè­°</strong><br>
        <div id="summaryText">è«‹é»æ“Šè¨ºæ–·ã€‚</div>
        <div id="diagTime" style="font-size: 12px; color: #888; margin-top: 8px;"></div>
    </div>
    
    <div class="result-card" id="resX" style="display: none;">
        <div id="resultX" style="font-size: 18px; font-weight: bold; color: var(--primary);"></div>
    </div>
    <div class="result-card" id="resY" style="display: none;">
        <div id="resultY" style="font-size: 18px; font-weight: bold; color: var(--success);"></div>
    </div>
</div>

<script>
const KEY = 'archery_final_formula';

function refreshList() {
    const list = document.getElementById('p_list');
    const data = JSON.parse(localStorage.getItem(KEY) || '{}');
    list.innerHTML = '<option value="">-- ç´€éŒ„ --</option>';
    Object.keys(data).sort().reverse().forEach(t => {
        const opt = document.createElement('option');
        opt.value = t; opt.innerText = t; list.appendChild(opt);
    });
}

document.getElementById('p_save').onclick = () => {
    const now = new Date();
    const time = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
    const vals = { x: document.getElementById('rawX').value, y: document.getElementById('rawY').value, k: document.getElementById('kValue').value };
    const history = JSON.parse(localStorage.getItem(KEY) || '{}');
    history[time] = vals;
    localStorage.setItem(KEY, JSON.stringify(history));
    refreshList(); alert('âœ… å­˜æª”æˆåŠŸ');
};

function loadRecord() {
    const d = JSON.parse(localStorage.getItem(KEY) || '{}')[document.getElementById('p_list').value];
    if (d) { document.getElementById('rawX').value = d.x; document.getElementById('rawY').value = d.y; document.getElementById('kValue').value = d.k; }
}

function delRecord() {
    const history = JSON.parse(localStorage.getItem(KEY) || '{}');
    delete history[document.getElementById('p_list').value];
    localStorage.setItem(KEY, JSON.stringify(history));
    refreshList();
}

function runDiag() {
    const k = parseFloat(document.getElementById('kValue').value) || 1;

    const calc = (id) => {
        const raw = document.getElementById(id).value.split(',').map(Number).filter(n => !isNaN(n));
        if (raw.length === 0) return 11;

        const right = raw.filter(n => n >= 0);
        const left = raw.filter(n => n < 0);

        const getAvg = (arr) => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
        const getMAD = (arr, avg) => arr.length ? arr.reduce((a,b)=>a+Math.abs(b-avg),0)/arr.length : 0;

        const avgR = getAvg(right);
        const avgL = getAvg(left);
        const madR = getMAD(right, avgR);
        const madL = getMAD(left, avgL);

        // å¥—ç”¨ä½ çš„å…¬å¼ï¼š11 - K * [(Avgå³ - Avgå·¦) + (NR*MADR + NL*MADL)/(NR+NL)]
        const weightedMAD = ( (right.length * madR) + (left.length * madL) ) / raw.length;
        const efi = 11 - k * ( (avgR - avgL) + weightedMAD );
        
        return efi;
    };

    const efiX = calc('rawX');
    const efiY = calc('rawY');

    document.getElementById('resX').style.display = 'block';
    document.getElementById('resY').style.display = 'block';
    document.getElementById('resultX').innerText = `EFI-X: ${efiX.toFixed(4)}`;
    document.getElementById('resultY').innerText = `EFI-Y: ${efiY.toFixed(4)}`;

    const now = new Date();
    document.getElementById('diagTime').innerText = `ğŸ•’ è¨ºæ–·æ™‚é–“ï¼š${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
    document.getElementById('summaryText').innerText = "è¨ºæ–·å®Œæˆã€‚";
}

window.onload = refreshList;
</script>
</body>
</html>
