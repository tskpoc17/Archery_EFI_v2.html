<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EFI å°„ç®­é›™è»¸è¨ºæ–·ç³»çµ±</title>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg); padding: 15px; display: flex; justify-content: center; margin: 0; }
        .container { background: white; width: 100%; max-width: 450px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); padding: 20px; box-sizing: border-box; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 22px; color: #333; margin: 0; }
        
        .setting-label { font-size: 14px; color: #555; margin-bottom: 8px; font-weight: bold; }
        .section-box { background: #e7f3ff; border-radius: 16px; padding: 15px; margin-bottom: 15px; border-left: 6px solid var(--primary); }
        .section-title { font-weight: bold; color: var(--primary); margin-bottom: 12px; font-size: 15px; }
        
        /* 12æ ¼ç¶²æ ¼æ’ç‰ˆ */
        .input-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .input-grid input { width: 100%; padding: 10px 5px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 14px; text-align: center; box-sizing: border-box; }
        .input-grid input:focus { border-color: var(--primary); outline: none; background: #fff; }

        input[type="number"] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .hint { font-size: 11px; color: #6c757d; margin-top: 5px; }
        
        button { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 16px; }
        .btn-diag { background: var(--primary); color: white; margin-bottom: 20px; }
        .btn-save { background: var(--success); color: white; margin-bottom: 10px; }
        
        .history-row { display: flex; gap: 8px; margin-bottom: 20px; }
        select { flex: 1.5; padding: 12px; border-radius: 12px; border: 1px solid #ddd; background: white; }
        .btn-load { flex: 0.8; background: #6f42c1; color: white; }
        .btn-del { flex: 0.6; background: var(--danger); color: white; }

        .analysis-box { background: #fff4e6; border-radius: 18px; padding: 20px; border: 1px solid #ffe8cc; font-size: 15px; line-height: 1.6; }
        .result-card { background: #fff; border-radius: 16px; padding: 15px; border: 1px solid #eef2f7; margin-top: 10px; }
        .res-val { font-size: 20px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header"><h1>ğŸ¯ EFI é›™è»¸è¨ºæ–·ç³»çµ±</h1></div>

    <div style="margin-bottom: 20px;">
        <div class="setting-label">âš™ï¸ è·é›¢æ›ç®— K å€¼è¨­å®š</div>
        <input type="number" id="kValue" value="1" step="0.1" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd;">
    </div>

    <div class="section-box">
        <div class="section-title">âš–ï¸ X è»¸æ°´å¹³åº§æ¨™ (12 ç®­)</div>
        <div class="input-grid" id="gridX">
            </div>
        <div class="hint">å³æ­£ (+) / å·¦è²  (-)</div>
    </div>

    <div class="section-box" style="background: #f0f7ff; border-left-color: #28a745;">
        <div class="section-title" style="color: #28a745;">â†•ï¸ Y è»¸å‚ç›´åº§æ¨™ (12 ç®­)</div>
        <div class="input-grid" id="gridY">
            </div>
        <div class="hint" style="color: #28a745;">ä¸Šæ­£ (+) / ä¸‹è²  (-)</div>
    </div>

    <button class="btn-diag" onclick="runDiag()">åŸ·è¡Œé›™è»¸æ•¸æ“šè¨ºæ–·</button>

    <button id="p_save" class="btn-save">ğŸ•’ å„²å­˜ç•¶å‰æ•¸æ“šèˆ‡æ™‚é–“</button>
    <div class="history-row">
        <select id="p_list"><option value="">-- æ­·å²ç´€éŒ„ --</option></select>
        <button class="btn-load" onclick="loadRecord()">è¼‰å…¥</button>
        <button class="btn-del" onclick="delRecord()">åˆªé™¤</button>
    </div>

    <div class="analysis-box">
        <strong>ğŸ’¡ ç¶œåˆåˆ†æå»ºè­°</strong><br>
        <div id="summaryText">è«‹å¡«å¯«åº§æ¨™å¾Œé»æ“Šè¨ºæ–·ã€‚</div>
        <div id="diagTime" style="font-size: 12px; color: #888; margin-top: 10px;"></div>
    </div>
    
    <div class="result-card" id="resX" style="display: none;">
        <div id="resultX" class="res-val" style="color: var(--primary);"></div>
    </div>
    <div class="result-card" id="resY" style="display: none;">
        <div id="resultY" class="res-val" style="color: var(--success);"></div>
    </div>
</div>

<script>
const KEY = 'archery_efi_grid_v4';

// åˆå§‹åŒ–ç”Ÿæˆ 12 å€‹æ ¼å­çš„å‡½æ•¸
function createGrid(containerId) {
    const container = document.getElementById(containerId);
    for (let i = 0; i < 12; i++) {
        const input = document.createElement('input');
        input.type = 'number';
        input.step = '0.1';
        input.placeholder = (i + 1);
        input.className = containerId + '-input';
        container.appendChild(input);
    }
}

createGrid('gridX');
createGrid('gridY');

function refreshList() {
    const list = document.getElementById('p_list');
    const data = JSON.parse(localStorage.getItem(KEY) || '{}');
    list.innerHTML = '<option value="">-- æ­·å²ç´€éŒ„ --</option>';
    Object.keys(data).sort().reverse().forEach(t => {
        const opt = document.createElement('option');
        opt.value = t; opt.innerText = t; list.appendChild(opt);
    });
}

document.getElementById('p_save').onclick = () => {
    const now = new Date();
    const time = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
    const getVals = (cls) => Array.from(document.getElementsByClassName(cls)).map(i => i.value);
    const history = JSON.parse(localStorage.getItem(KEY) || '{}');
    history[time] = { x: getVals('gridX-input'), y: getVals('gridY-input'), k: document.getElementById('kValue').value };
    localStorage.setItem(KEY, JSON.stringify(history));
    refreshList(); alert('âœ… å­˜æª”æˆåŠŸ');
};

function loadRecord() {
    const d = JSON.parse(localStorage.getItem(KEY) || '{}')[document.getElementById('p_list').value];
    if (d) {
        const xInputs = document.getElementsByClassName('gridX-input');
        const yInputs = document.getElementsByClassName('gridY-input');
        d.x.forEach((v, i) => xInputs[i].value = v);
        d.y.forEach((v, i) => yInputs[i].value = v);
        document.getElementById('kValue').value = d.k;
    }
}

function delRecord() {
    if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
    const history = JSON.parse(localStorage.getItem(KEY) || '{}');
    delete history[document.getElementById('p_list').value];
    localStorage.setItem(KEY, JSON.stringify(history));
    refreshList();
}

function runDiag() {
    const k = parseFloat(document.getElementById('kValue').value) || 1;

    const calc = (cls) => {
        const raw = Array.from(document.getElementsByClassName(cls))
                         .map(i => parseFloat(i.value))
                         .filter(n => !isNaN(n));
        if (raw.length === 0) return 11;

        const right = raw.filter(n => n >= 0);
        const left = raw.filter(n => n < 0);

        const getAvg = (arr) => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
        const getMAD = (arr, avg) => arr.length ? arr.reduce((a,b)=>a+Math.abs(b-avg),0)/arr.length : 0;

        const avgR = getAvg(right);
        const avgL = getAvg(left);
        const madR = getMAD(right, avgR);
        const madL = getMAD(left, avgL);

        // æ ¸å¿ƒå…¬å¼ï¼š11 - K * [(Avgå³ - Avgå·¦) + (NR*MADR + NL*MADL)/(NR+NL)]
        const weightedMAD = ( (right.length * madR) + (left.length * madL) ) / raw.length;
        const efi = 11 - k * ( (avgR - avgL) + (weightedMAD || 0) );
        return efi;
    };

    const efiX = calc('gridX-input');
    const efiY = calc('gridY-input');

    document.getElementById('resX').style.display = 'block';
    document.getElementById('resY').style.display = 'block';
    document.getElementById('resultX').innerText = `EFI-X: ${efiX.toFixed(4)}`;
    document.getElementById('resultY').innerText = `EFI-Y: ${efiY.toFixed(4)}`;

    const now = new Date();
    document.getElementById('diagTime').innerText = `ğŸ•’ è¨ºæ–·æ™‚é–“ï¼š${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
}

window.onload = refreshList;
</script>
</body>
</html>
