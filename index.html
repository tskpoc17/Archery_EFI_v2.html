<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°„ç®­é›™è»¸æ•¸æ“šè¨ºæ–· App</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 15px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h2 { color: #1c1e21; font-size: 1.2rem; margin-top: 0; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 14px; color: #606770; margin-bottom: 5px; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .primary-btn { background: #007bff; color: white; font-size: 16px; }
        .result-box { background: #fff9db; padding: 15px; border-radius: 10px; border: 1px solid #ffe066; }
        .summary-block { margin-top: 15px; font-size: 14px; line-height: 1.6; }
        .footer-text { font-size: 12px; color: #888; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ¯ é›™è»¸æ•¸æ“šè¼¸å…¥</h2>
    <div class="input-group">
        <label>æ°´å¹³å¹³å‡å·® (pxE) / å³å´ç‚ºæ­£ (+)ï¼Œå·¦å´ç‚ºè²  (-)</label>
        <input type="number" id="pxE" placeholder="ä¾‹å¦‚: 1.5 (ä»£è¡¨åå³1æ ¼)" step="0.1">
    </div>
    <div class="input-group">
        <label>æ°´å¹³å¹³å‡é›¢å·® (pxM)</label>
        <input type="number" id="pxM" placeholder="ä¾‹å¦‚: 0.8" step="0.1">
    </div>
    <div class="input-group">
        <label>æ°´å¹³æ¨£æœ¬æ•¸ (æ”¯æ•¸)</label>
        <input type="number" id="inX" placeholder="ä¾‹å¦‚: 6">
    </div>
    <hr>
    <div class="input-group">
        <label>å‚ç›´å¹³å‡å·® (pyE) / ä¸Šæ–¹ç‚ºæ­£ (+)ï¼Œä¸‹æ–¹ç‚ºè²  (-)</label>
        <input type="number" id="pyE" placeholder="ä¾‹å¦‚: -1.0 (ä»£è¡¨åä¸‹1æ ¼)" step="0.1">
    </div>
    <div class="input-group">
        <label>å‚ç›´å¹³å‡é›¢å·® (pyM)</label>
        <input type="number" id="pyM" placeholder="ä¾‹å¦‚: 0.5" step="0.1">
    </div>
    <div class="input-group">
        <label>å‚ç›´æ¨£æœ¬æ•¸ (æ”¯æ•¸)</label>
        <input type="number" id="inY" placeholder="ä¾‹å¦‚: 6">
    </div>
    <div class="input-group">
        <label>è·é›¢ä¿‚æ•¸ (kValue)</label>
        <input type="number" id="kValue" value="0.1" step="0.01">
    </div>
    
    <button class="primary-btn" onclick="runDiag()">åŸ·è¡Œé›™è»¸æ•¸æ“šè¨ºæ–·</button>
</div>

<div class="card result-box">
    <h2>ğŸ“Š è¨ºæ–·çµæœ</h2>
    <div id="resultX" style="font-weight: bold; color: #007bff;">æ°´å¹³æ•ˆç‡ (EFI-X): --</div>
    <div id="resultY" style="font-weight: bold; color: #28a745;">å‚ç›´æ•ˆç‡ (EFI-Y): --</div>
    <div class="summary-block">
        <strong>ç¶œåˆåˆ†æå»ºè­°ï¼š</strong>
        <div id="summaryText">è«‹è¼¸å…¥æ•¸æ“šä¸¦é»æ“Šè¨ºæ–·ã€‚</div>
    </div>
</div>

<div class="footer-text">æç¤ºï¼šæ­¤ç‰ˆæœ¬ä½¿ç”¨ã€Œç’°æ•¸è·é›¢ã€ä½œç‚ºè¨ˆç®—å–®ä½</div>

<script>
// --- åŸæœ¬çš„ runDiag å‡½æ•¸ (ä¿ç•™çµæ§‹ï¼Œä½†å…§å®¹æœƒè¢«ä¸‹æ–¹å¤–æ›ç½®æ›) ---
function runDiag() {
    console.log("Original logic triggered");
}

// --- ğŸ”Œ æ ¸å¿ƒå¤–æ›ï¼šå…¬å¼ç½®æ› + ç´€éŒ„ç®¡ç† + æ™‚é–“æˆ³è¨˜ ---
(function() {
    const STORAGE_KEY = 'archery_history_list_v2';

    window.addEventListener('load', function() {
        const mainBtn = document.querySelector('button[onclick="runDiag()"]');
        if (!mainBtn) return;

        // 1. å»ºç«‹ UIï¼šæ­·å²ç´€éŒ„ç®¡ç†
        const pluginContainer = document.createElement('div');
        pluginContainer.style = "margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; border: 1px solid #ddd;";
        pluginContainer.innerHTML = `
            <div style="font-weight:bold; font-size:14px; margin-bottom:10px; color:#555;">ğŸ’¾ æ­·å²ç´€éŒ„ç®¡ç† (ç’°æ•¸å–®ä½æ¨¡å¼)</div>
            <button id="p_btnSave" style="width:100%; height:48px; background:#28a745; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer; margin-bottom:12px; font-size:16px; display:flex; align-items:center; justify-content:center;">ğŸ•’ ä»¥ç•¶å‰æ™‚é–“å„²å­˜æ•¸æ“š</button>
            <div style="display:flex; gap:8px; align-items: center;">
                <select id="p_recordSelect" style="flex:1.2; padding:0 10px; border-radius:8px; border:1px solid #ccc; height:48px; font-size:14px; background:white;"></select>
                <button id="p_btnLoad" style="flex:2; height:48px; background:#6f42c1; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:15px; display:flex; align-items:center; justify-content:center;">è¼‰å…¥ç´€éŒ„</button>
                <button id="p_btnDel" style="width:55px; height:48px; background:#dc3545; color:white; border:none; border-radius:8px; font-size:13px; cursor:pointer; display:flex; align-items:center; justify-content:center;">åˆªé™¤</button>
            </div>
        `;
        mainBtn.parentNode.insertBefore(pluginContainer, mainBtn.nextSibling);

        const recordSelect = document.getElementById('p_recordSelect');
        const updateDropdown = () => {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            recordSelect.innerHTML = '<option value="">ç´€éŒ„</option>';
            Object.keys(history).sort().reverse().forEach(time => {
                const opt = document.createElement('option');
                opt.value = time; opt.innerText = time;
                recordSelect.appendChild(opt);
            });
        };

        // å„²å­˜ã€è¼‰å…¥ã€åˆªé™¤é‚è¼¯
        document.getElementById('p_btnSave').onclick = () => {
            const now = new Date();
            const timeKey = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
            const data = {
                pxE: document.getElementById('pxE').value, pxM: document.getElementById('pxM').value, inX: document.getElementById('inX').value,
                pyE: document.getElementById('pyE').value, pyM: document.getElementById('pyM').value, inY: document.getElementById('inY').value,
                k: document.getElementById('kValue').value
            };
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            history[timeKey] = data;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            updateDropdown(); alert('âœ… å·²å„²å­˜æ­·å²ç´€éŒ„');
        };

        document.getElementById('p_btnLoad').onclick = () => {
            const d = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}')[recordSelect.value];
            if (d) {
                document.getElementById('pxE').value = d.pxE; document.getElementById('pxM').value = d.pxM; document.getElementById('inX').value = d.inX;
                document.getElementById('pyE').value = d.pyE; document.getElementById('pyM').value = d.pyM; document.getElementById('inY').value = d.inY;
                document.getElementById('kValue').value = d.k; alert('ğŸ“‚ è¼‰å…¥æˆåŠŸ');
            }
        };

        document.getElementById('p_btnDel').onclick = () => {
            if (!recordSelect.value || !confirm('ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ')) return;
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            delete history[recordSelect.value];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            updateDropdown();
        };

        updateDropdown();

        // 2. å…¬å¼ç½®æ›é‚è¼¯ (EFI = 11 - K * [Gap + MAD])
        window.runDiag = function() {
            const pxE = parseFloat(document.getElementById('pxE').value) || 0;
            const pxM = parseFloat(document.getElementById('pxM').value) || 0;
            const pyE = parseFloat(document.getElementById('pyE').value) || 0;
            const pyM = parseFloat(document.getElementById('pyM').value) || 0;
            const k = parseFloat(document.getElementById('kValue').value) || 0.1;

            // æ–°å…¬å¼ï¼šè©•ä¼°å…©æ¥µåå·®èˆ‡ä¸€è‡´æ€§
            const efiX = 11 - k * (Math.abs(pxE) + pxM);
            const efiY = 11 - k * (Math.abs(pyE) + pyM);

            document.getElementById('resultX').innerText = `æ°´å¹³æ•ˆç‡ (EFI-X): ${efiX.toFixed(2)}`;
            document.getElementById('resultY').innerText = `å‚ç›´æ•ˆç‡ (EFI-Y): ${efiY.toFixed(2)}`;

            const summaryText = document.getElementById('summaryText');
            if(summaryText) {
                let diag = "åŸºæ–¼é¶é¢åˆ†æ•¸ä¹‹è¨ºæ–·åˆ†æï¼š\n";
                if (efiX >= 9 && efiY >= 9) diag += "ğŸ¯ è¡¨ç¾æ¥µå…¶å„ªç•°ï¼Œå‹•ä½œæ¥µåº¦ç©©å®šã€‚";
                else if (efiX < 7 || efiY < 7) diag += "âš ï¸ å‹•ä½œä¸€è‡´æ€§æœ‰å¾…åŠ å¼·ï¼Œè«‹æ³¨æ„æ¥µç«¯è½é»ã€‚";
                else diag += "âœ… è¡¨ç¾æ­£å¸¸ï¼Œå»ºè­°å¾®èª¿ç„å…·è£œå„Ÿä¸­å¿ƒåå·®ã€‚";
                
                const now = new Date();
                diag += `\n\nğŸ•’ è¨ºæ–·æ™‚é–“ï¼š${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
                summaryText.innerText = diag;
            }
        };
    });
})();
</script>

</body>
</html>
