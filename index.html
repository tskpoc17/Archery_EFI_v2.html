<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EFI å°„ç®­é›™è»¸è¨ºæ–·ç³»çµ±</title>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg); padding: 15px; display: flex; justify-content: center; margin: 0; }
        .container { background: white; width: 100%; max-width: 450px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); padding: 20px; box-sizing: border-box; }
        .header { text-align: center; margin-bottom: 20px; }
        
        /* 12æ ¼å¤–æ›æ¨£å¼ */
        .grid-12 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .grid-12 input { width: 100%; padding: 10px 5px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 14px; text-align: center; box-sizing: border-box; }

        .section-box { border-radius: 16px; padding: 15px; margin-bottom: 15px; border-left: 6px solid var(--primary); background: #f8fbff; }
        .section-title { font-weight: bold; color: var(--primary); margin-bottom: 10px; font-size: 15px; }
        
        button { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 16px; margin-bottom: 10px; transition: 0.2s; }
        .btn-diag { background: var(--primary); color: white; }
        .btn-save { background: var(--success); color: white; }
        .history-row { display: flex; gap: 8px; margin-bottom: 15px; }
        
        .analysis-box { background: #fff4e6; border-radius: 18px; padding: 20px; border: 1px solid #ffe8cc; font-size: 15px; line-height: 1.6; }
        .result-card { background: #f8f9ff; border-radius: 16px; padding: 15px; border: 1px solid #eef2f7; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header"><h1>ğŸ¯ EFI é›™è»¸è¨ºæ–·ç³»çµ±</h1></div>

    <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
        <span style="font-weight: bold; font-size: 14px;">K å€¼ï¼š</span>
        <input type="number" id="kValue" value="1" step="0.1" style="flex:1; padding:10px; border-radius:10px; border:1px solid #ddd;">
    </div>

    <div class="section-box">
        <div class="section-title">âš–ï¸ X è»¸æ°´å¹³åº§æ¨™ (12 ç®­)</div>
        <div class="grid-12" id="gridX"></div>
    </div>

    <div class="section-box" style="background: #f0f7ff; border-left-color: var(--success);">
        <div class="section-title" style="color: var(--success);">â†•ï¸ Y è»¸å‚ç›´åº§æ¨™ (12 ç®­)</div>
        <div class="grid-12" id="gridY"></div>
    </div>

    <button class="btn-diag" onclick="runDiag()">åŸ·è¡Œé›™è»¸æ•¸æ“šè¨ºæ–·</button>

    <button id="p_save" class="btn-save">ğŸ•’ å„²å­˜ç•¶å‰æ•¸æ“šèˆ‡æ™‚é–“</button>
    <div class="history-row">
        <select id="p_list" style="flex:2; padding:10px; border-radius:10px;"><option value="">-- æ­·å²ç´€éŒ„ --</option></select>
        <button onclick="loadRecord()" style="flex:1; background:#6f42c1; color:white; border-radius:10px;">è¼‰å…¥</button>
        <button onclick="delRecord()" style="flex:0.8; background:#dc3545; color:white; border-radius:10px;">åˆªé™¤</button>
    </div>

    <div class="analysis-box">
        <strong>ğŸ’¡ ç¶œåˆåˆ†æå»ºè­°</strong><br>
        <div id="summaryText">è«‹å¡«å¯«åº§æ¨™å¾Œé»æ“Šè¨ºæ–·ã€‚</div>
        <div id="adviceContent" style="margin-top: 10px;"></div>
        <div id="diagTime" style="font-size: 12px; color: #888; margin-top: 10px;"></div>
    </div>

    <div class="result-card"><div id="resultX" style="color: var(--primary); font-weight:bold; font-size:18px;">EFI-X: --</div></div>
    <div class="result-card"><div id="resultY" style="color: var(--success); font-weight:bold; font-size:18px;">EFI-Y: --</div></div>
</div>

<script>
// åˆå§‹åŒ– 12 æ ¼
function init() {
    const gx = document.getElementById('gridX'), gy = document.getElementById('gridY');
    for (let i = 0; i < 12; i++) {
        gx.innerHTML += `<input type="number" step="0.1" class="x-in" placeholder="${i+1}">`;
        gy.innerHTML += `<input type="number" step="0.1" class="y-in" placeholder="${i+1}">`;
    }
}
init();

// --- æ ¸å¿ƒæ–°å…¬å¼é‹ç®—é‚è¼¯ ---
function runDiag() {
    const k = parseFloat(document.getElementById('kValue').value) || 1;
    const getVals = (cls) => Array.from(document.getElementsByClassName(cls)).map(i => parseFloat(i.value)).filter(n => !isNaN(n));
    
    const xData = getVals('x-in'), yData = getVals('y-in');

    const calculateNewEFI = (data) => {
        if (!data.length) return { efi: 11, avgR: 0, avgL: 0 };
        
        const right = data.filter(n => n >= 0);
        const left = data.filter(n => n < 0);

        const getAvg = (arr) => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
        const getMAD = (arr, avg) => arr.length ? arr.reduce((acc,v)=>acc+Math.abs(v-avg),0)/arr.length : 0;

        const avgR = getAvg(right);
        const avgL = getAvg(left); // é€™è£¡åŒ…å«è² è™Ÿ
        const madR = getMAD(right, avgR);
        const madL = getMAD(left, avgL);

        // æ–°å…¬å¼ï¼š11 - K * [ (Avgå³ - Avgå·¦) + (NR*MADR + NL*MADL)/Nç¸½ ]
        // æ³¨æ„ï¼šAvgå³ - Avgå·¦ æœƒè‡ªå‹•è®Šæˆç›¸åŠ  (ä¾‹å¦‚ 2 - (-2) = 4)
        const weightedMAD = ((right.length * madR) + (left.length * madL)) / data.length;
        const efi = 11 - k * ((avgR - avgL) + (weightedMAD || 0));
        
        return { efi, avgR, avgL };
    };

    const resX = calculateNewEFI(xData), resY = calculateNewEFI(yData);

    // é¡¯ç¤º EFI
    document.getElementById('resultX').innerText = `EFI-X: ${resX.efi.toFixed(4)}`;
    document.getElementById('resultY').innerText = `EFI-Y: ${resY.efi.toFixed(4)}`;

    // åˆ†æå»ºè­°æ–‡å­— (ä¿ç•™ä½ åŸæœ¬çš„è¨ºæ–·é‚è¼¯)
    let advice = "";
    if (resY.efi < 8.5) advice += "âš ï¸ **å‚ç›´ç©©å®šåº¦è­¦ç¤º**ï¼šå‚ç›´ EFI ä½æ–¼ 8.5ï¼Œå»ºè­°æª¢æŸ¥é å¼¦é»ä¸€è‡´æ€§ã€‚<br>";
    if (resX.efi < 8.5) advice += "âš ï¸ **æ°´å¹³ç©©å®šåº¦è­¦ç¤º**ï¼šæ°´å¹³ EFI ä½æ–¼ 8.5ï¼Œå»ºè­°æª¢æŸ¥æ”¾ç®­å‹•èƒ½èˆ‡å¾Œè‚˜ã€‚<br>";
    advice += `ğŸ› ï¸ **ç„æº–å™¨èª¿æ•´æ–¹å‘**ï¼šå»ºè­°å‘ ${resX.avgR + resX.avgL > 0 ? 'å³' : 'å·¦'} ä¸”å‘ ${resY.avgR + resY.avgL > 0 ? 'ä¸Š' : 'ä¸‹'} å¾®èª¿ã€‚`;

    document.getElementById('summaryText').innerText = "è¨ºæ–·åˆ†æå®Œæˆã€‚";
    document.getElementById('adviceContent').innerHTML = advice;
    document.getElementById('diagTime').innerText = "ğŸ•’ è¨ºæ–·æ™‚é–“ï¼š" + new Date().toLocaleString();
}

// æ­·å²ç´€éŒ„ç®¡ç† (èˆ‡ 12 æ ¼å°æ¥)
const KEY = 'Archery_EFI_v2_Stable';
document.getElementById('p_save').onclick = () => {
    const data = JSON.parse(localStorage.getItem(KEY) || '{}');
    const time = new Date().toLocaleString();
    data[time] = { 
        x: Array.from(document.getElementsByClassName('x-in')).map(i => i.value),
        y: Array.from(document.getElementsByClassName('y-in')).map(i => i.value),
        k: document.getElementById('kValue').value
    };
    localStorage.setItem(KEY, JSON.stringify(data));
    loadRecords(); alert('âœ… æ•¸æ“šå·²æˆåŠŸå­˜æª”');
};

function loadRecords() {
    const list = document.getElementById('p_list'), data = JSON.parse(localStorage.getItem(KEY) || '{}');
    list.innerHTML = '<option value="">-- æ­·å²ç´€éŒ„ --</option>';
    Object.keys(data).reverse().forEach(t => list.innerHTML += `<option value="${t}">${t}</option>`);
}
function loadRecord() {
    const d = JSON.parse(localStorage.getItem(KEY) || '{}')[document.getElementById('p_list').value];
    if (d) {
        const xi = document.getElementsByClassName('x-in'), yi = document.getElementsByClassName('y-in');
        d.x.forEach((v, i) => xi[i].value = v); 
        d.y.forEach((v, i) => yi[i].value = v);
        document.getElementById('kValue').value = d.k;
    }
}
function delRecord() {
    if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
    const data = JSON.parse(localStorage.getItem(KEY) || '{}');
    delete data[document.getElementById('p_list').value];
    localStorage.setItem(KEY, JSON.stringify(data));
    loadRecords();
}
window.onload = loadRecords;
</script>
</body>
</html>
