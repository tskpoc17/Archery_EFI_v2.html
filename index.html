<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EFI å°„ç®­é›™è»¸è¨ºæ–·ç³»çµ±</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 480px; }
        h2 { text-align: center; color: #333; margin-top: 0; }
        .section-title { background: #e7f3ff; padding: 10px 15px; border-radius: 8px; font-weight: bold; color: #007AFF; margin: 20px 0 10px 0; border-left: 5px solid #007AFF; }
        label { font-weight: bold; font-size: 14px; color: #333; display: block; margin-top: 12px; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; background-color: #fff; }
        
        /* 12æ ¼å¤–æ›æ¨£å¼ */
        .grid-12 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .grid-12 input { padding: 10px 5px; text-align: center; font-size: 14px; border-radius: 8px; }

        .note { font-size: 12px; color: #777; background-color: #f8f9fa; padding: 8px; border-radius: 8px; margin-top: 4px; line-height: 1.4; }
        button { width: 100%; padding: 16px; background: #007AFF; color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 25px; }
        .res-container { display: none; margin-top: 25px; }
        .res-block { padding: 18px; background: #f0f9ff; border-radius: 15px; border: 1px solid #bce0fd; margin-bottom: 20px; }
        .summary-block { padding: 18px; background: #fff4e5; border-radius: 15px; border: 1px solid #ffe2b3; margin-bottom: 20px; }
        .stat-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #d1e9ff; font-size: 14px; align-items: center; }
        .stat-value { font-weight: bold; text-align: right; color: #333; }
        .efi-val { color: #007AFF; font-size: 24px; font-weight: 900; }
    </style>
</head>
<body>
<div class="card">
    <h2>ğŸ¯ EFI å°„ç®­é›™è»¸è¨ºæ–·ç³»çµ±</h2>

    <label>ğŸ¯ è·é›¢æ¨ä¼°ä¿‚æ•¸ K å€¼è¨­å®š</label>
    <div style="margin-bottom: 15px;">
        <input type="number" id="kValue" value="1" step="0.1" placeholder="è«‹è¼¸å…¥ K å€¼">
    </div>

    <div class="section-title">âš–ï¸ X è»¸æ°´å¹³åº§æ¨™ (12 ç®­)</div>
    <div class="grid-12" id="gridX"></div>
    <div class="note">å³å´ç‚ºæ­£ (+)ï¼Œå·¦å´ç‚ºè²  (-)</div>

    <div class="section-title">â†•ï¸ Y è»¸å‚ç›´åº§æ¨™ (12 ç®­)</div>
    <div class="grid-12" id="gridY"></div>
    <div class="note">ä¸Šæ–¹ç‚ºæ­£ (+)ï¼Œä¸‹æ–¹ç‚ºè²  (-)</div>

    <button onclick="runDiag()">åŸ·è¡Œé›™è»¸æ•¸æ“šè¨ºæ–·</button>

    <div id="out" class="res-container">
        <div id="summary" class="summary-block">
            <div style="font-weight:bold; color:#e67e22; margin-bottom:8px;">ğŸ’¡ ç¶œåˆåˆ†æå»ºè­°</div>
            <div id="summaryText" style="font-size:15px; line-height:1.5; color:#5d4037; white-space: pre-wrap;"></div>
        </div>

        <div class="res-block">
            <div style="font-weight:bold; color:#007AFF; margin-bottom:12px;">ğŸ“Š X è»¸æ°´å¹³åˆ†æå ±å‘Š</div>
            <div class="stat-item"><span>æœ¬æ¬¡ EFI æŒ‡æ¨™</span><span id="rxE" class="efi-val"></span></div>
            <div class="stat-item"><span>ä¸­å¿ƒåç§»å¹³å‡</span><span id="offX" class="stat-value"></span></div>
            <div class="stat-item"><span>å‹•ä½œä¸€è‡´æ€§ (é›¢å·®)</span><span id="madX" class="stat-value"></span></div>
        </div>

        <div class="res-block">
            <div style="font-weight:bold; color:#007AFF; margin-bottom:12px;">ğŸ“Š Y è»¸å‚ç›´åˆ†æå ±å‘Š</div>
            <div class="stat-item"><span>æœ¬æ¬¡ EFI æŒ‡æ¨™</span><span id="ryE" class="efi-val"></span></div>
            <div class="stat-item"><span>ä¸­å¿ƒåç§»å¹³å‡</span><span id="offY" class="stat-value"></span></div>
            <div class="stat-item"><span>å‹•ä½œä¸€è‡´æ€§ (é›¢å·®)</span><span id="madY" class="stat-value"></span></div>
        </div>
    </div>
</div>

<script>
// åˆå§‹åŒ– 12 æ ¼
(function init() {
    const gx = document.getElementById('gridX'), gy = document.getElementById('gridY');
    for (let i = 0; i < 12; i++) {
        gx.innerHTML += `<input type="number" step="0.1" class="xin" placeholder="${i+1}">`;
        gy.innerHTML += `<input type="number" step="0.1" class="yin" placeholder="${i+1}">`;
    }
})();

// --- æ ¸å¿ƒç®—æ³•ï¼šå›æ­¸åŸå§‹ã€Œè·æ•´é«”å¹³å‡ä¸­å¿ƒè·é›¢ã€ä¹‹é‚è¼¯ ---
function coreCalc(raw, k) {
    // 1. è¨ˆç®—æ•´é«”å¹³å‡å€¼ (d)
    const overallAvg = raw.reduce((a, b) => a + b) / raw.length;
    
    // 2. ä¾ç…§ã€Œæ•´é«”å¹³å‡å€¼ã€åˆ†çµ„ (åŸå§‹é‚è¼¯)
    const R = raw.filter(v => v >= overallAvg), L = raw.filter(v => v < overallAvg);
    
    // 3. è¨ˆç®—å„çµ„å…§éƒ¨çš„å¹³å‡é›¢å·® (MAD)
    const getM = (a) => {
        if (!a.length) return 0;
        const subAvg = a.reduce((p, c) => p + c) / a.length;
        return a.reduce((p, c) => p + Math.abs(c - subAvg), 0) / a.length;
    };
    const mR = getM(R), mL = getM(L);

    // 4. è¨ˆç®—å–®å´ä¸­å¿ƒèˆ‡æ•´é«”ä¸­å¿ƒçš„ä½ç§»è·é›¢ (dR, dL)
    const dR = R.length ? Math.abs((R.reduce((a,b)=>a+b)/R.length) - overallAvg) : 0;
    const dL = L.length ? Math.abs((L.reduce((a,b)=>a+b)/L.length) - overallAvg) : 0;

    // 5. åŸå§‹æ‡²ç½°é …å…¬å¼ï¼šK*dR + K*dL + K*(åŠ æ¬Šé›¢å·®)
    const weightedMAD = ((R.length * mR) + (L.length * mL)) / raw.length;
    const penalty = (k * dR) + (k * dL) + (k * weightedMAD);

    // 6. åŸå§‹ EFI æ›ç®— (10 * (é¶ç´™åŠå¾‘ - æ‡²ç½°)/é¶ç´™åŠå¾‘ + 1)
    // è¨»ï¼šé€™è£¡é è¨­æ¡ç”¨ä½ åŸæœ¬ 80cm é¶ç´™çš„åŠå¾‘ 40 åšåŸºæº–ï¼Œæˆ–ä½ å¯ä»¥è‡ªå®šç¾©
    const faceRadius = 40; 
    const efi = parseFloat((10 * ((faceRadius - penalty) / faceRadius) + 1).toFixed(4));
    
    return { efi, mad: weightedMAD, avg: overallAvg };
}

function runDiag() {
    const k = parseFloat(document.getElementById('kValue').value) || 1;
    const getInputs = (cls) => Array.from(document.getElementsByClassName(cls)).map(i => parseFloat(i.value)).filter(n => !isNaN(n));
    
    const xData = getInputs('xin'), yData = getInputs('yin');
    if (xData.length < 2 || yData.length < 2) return alert("è«‹è‡³å°‘è¼¸å…¥å…©ç­†æ•¸æ“š");

    document.getElementById('out').style.display = 'block';
    const resX = coreCalc(xData, k), resY = coreCalc(yData, k);

    document.getElementById('rxE').innerText = resX.efi;
    document.getElementById('offX').innerText = `${resX.avg.toFixed(2)} cm ${resX.avg < 0 ? "(åå·¦)" : "(åå³)"}`;
    document.getElementById('madX').innerText = resX.mad.toFixed(2);

    document.getElementById('ryE').innerText = resY.efi;
    document.getElementById('offY').innerText = `${resY.avg.toFixed(2)} cm ${resY.avg < 0 ? "(åä¸‹)" : "(åä¸Š)"}`;
    document.getElementById('madY').innerText = resY.mad.toFixed(2);

    // ç¶œåˆåˆ†ææ–‡å­—
    let summary = resX.efi < resY.efi ? "âš ï¸ æ³¨æ„ X è»¸ (æ°´å¹³)ï¼šç©©å®šåº¦è¼ƒä½ã€‚" : "âš ï¸ æ³¨æ„ Y è»¸ (å‚ç›´)ï¼šç©©å®šåº¦è¼ƒä½ã€‚";
    summary += `\n\nğŸ› ï¸ **èª¿æ•´å»ºè­°**ï¼šå‘ã€${resX.avg < 0 ? "å·¦" : "å³"}ã€‘ä¸”å‘ã€${resY.avg < 0 ? "ä¸‹" : "ä¸Š"}ã€‘èª¿æ•´ã€‚`;
    document.getElementById('summaryText').innerText = summary;
}
</script>

<script>
// æ­·å²ç´€éŒ„å¤–æ›
(function() {
    const STORAGE_KEY = 'archery_history_v12_stable';
    window.addEventListener('load', function() {
        const mainBtn = document.querySelector('button[onclick="runDiag()"]');
        const plugin = document.createElement('div');
        plugin.style = "margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; border: 1px solid #ddd;";
        plugin.innerHTML = `
            <button id="p_save" style="width:100%; height:44px; background:#28a745; color:white; border:none; border-radius:10px; font-weight:bold; margin-bottom:10px;">ğŸ•’ å„²å­˜æ•¸æ“š</button>
            <div style="display:flex; gap:5px;"><select id="p_sel" style="flex:1.5; height:44px;"></select><button id="p_load" style="flex:1; background:#6f42c1; color:white; border:none; border-radius:8px;">è¼‰å…¥</button></div>
        `;
        mainBtn.parentNode.insertBefore(plugin, mainBtn.nextSibling);
        const sel = document.getElementById('p_sel');
        const update = () => {
            const h = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            sel.innerHTML = '<option value="">ç´€éŒ„æ¸…å–®</option>';
            Object.keys(h).sort().reverse().forEach(t => sel.innerHTML += `<option value="${t}">${t}</option>`);
        };
        document.getElementById('p_save').onclick = () => {
            const h = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            h[new Date().toLocaleString()] = { x: Array.from(document.getElementsByClassName('xin')).map(i=>i.value), y: Array.from(document.getElementsByClassName('yin')).map(i=>i.value), k: document.getElementById('kValue').value };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(h)); update(); alert('å·²å­˜');
        };
        document.getElementById('p_load').onclick = () => {
            const d = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}')[sel.value];
            if(d) {
                Array.from(document.getElementsByClassName('xin')).forEach((i,idx)=>i.value=d.x[idx]);
                Array.from(document.getElementsByClassName('yin')).forEach((i,idx)=>i.value=d.y[idx]);
                document.getElementById('kValue').value = d.k;
            }
        };
        update();
    });
})();
</script>
</body>
</html>
